<!-- =========================
= index.html  (Monitor Control UI)
========================= -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>모니터 / Monitor Control UI</title>
  <style>
    :root {
      --bg:#0f172a; --panel:#111827; --muted:#6b7280; --card:#0b1220; --acc:#3b82f6;
      --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --text:#e5e7eb; --radius:12px; --gap:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:24px;
      background: radial-gradient(1200px 700px at 70% -10%, #1f2937 0%, #0b1220 45%, #030712 100%);
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'PingFang SC', 'Noto Sans CJK SC', 'Noto Sans KR', 'Microsoft Yahei', sans-serif;
    }
    .wrap{max-width:1100px; margin:0 auto;}
    h1{font-size:22px; font-weight:700; letter-spacing:.2px; margin:0 0 14px 0;}
    .subtitle{color:var(--muted); margin-left:6px}
    .topbar{display:flex; justify-content:space-between; align-items:center; margin-bottom:14px}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      padding:18px;
      box-shadow: 0 20px 40px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.04);
    }
    .all-actions{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:14px;
      padding:12px; border:1px solid rgba(255,255,255,.06); border-radius:10px;
      background: rgba(17,24,39,.55);
    }
    .tag{font-size:12px; color:#cbd5e1; background:rgba(59,130,246,.15); border:1px solid rgba(59,130,246,.35);
      padding:4px 8px; border-radius:999px; letter-spacing:.2px}
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{
      text-align:center; font-weight:700; font-size:14px; padding:14px 6px;
      position:sticky; top:0; background:rgba(2,6,23,.7); backdrop-filter: blur(8px);
    }
    thead th:first-child{ text-align:left; padding-left:12px}
    tbody th{
      text-align:left; font-weight:600; color:#cbd5e1; padding:12px; width:170px;
      background: rgba(2,6,23,.35); position:relative;
    }
    tbody tr:nth-child(odd) td{ background: rgba(255,255,255,.03)}
    tbody tr:nth-child(even) td{ background: rgba(255,255,255,.02)}
    td{padding:10px 8px; text-align:center; vertical-align:middle;}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      height:34px; padding:0 12px; border-radius:10px; border:1px solid transparent;
      background:#0b1220; color:#e5e7eb; cursor:pointer; user-select:none;
      transition:.18s ease; box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn:hover{transform: translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06)}
    .btn:active{transform: translateY(0) scale(.99)}
    .primary{ background: linear-gradient(180deg, #2563eb, #1d4ed8); border-color: rgba(59,130,246,.6)}
    .danger{ background: linear-gradient(180deg, #ef4444, #dc2626); border-color: rgba(239,68,68,.6)}
    .ghost{ background: rgba(255,255,255,.04); border-color: rgba(148,163,184,.25)}
    .status{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      white-space: nowrap; width:15ch; justify-content: flex-start;
      background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); font-size:12px;
    }
    .dot{width:8px; height:8px; border-radius:50%}
    .idle .dot{background:#64748b}
    .rec .dot{background:#ef4444; box-shadow:0 0 0 6px rgba(239,68,68,.12)}
    .capturing .dot{background:#f59e0b; box-shadow:0 0 0 6px rgba(245,158,11,.12)}
    .grid{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:var(--gap); }
    @media (max-width: 860px){ .grid{ grid-template-columns:1fr }}
    .field{ display:flex; flex-direction:column; gap:6px }
    label{ font-size:12px; color:#cbd5e1; letter-spacing:.2px }
    input{ height:40px; padding:0 12px; border-radius:10px; outline:none;
      border:1px solid rgba(148,163,184,.35); background:rgba(255,255,255,.04); color:var(--text); }
    .note{ color:#9aa4b2; font-size:12px; margin-top:6px }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:12px; background:rgba(255,255,255,.06); padding:2px 6px; border-radius:6px; border:1px solid rgba(255,255,255,.12);}
    .footer{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:18px; flex-wrap:wrap}
    .toast{ position:fixed; right:16px; bottom:16px; padding:10px 14px; border-radius:10px;
      background:#0b1220; border:1px solid rgba(148,163,184,.25); color:#e5e7eb;
      box-shadow:0 8px 18px rgba(0,0,0,.35); opacity:0; transform: translateY(6px);
      transition:.2s ease; pointer-events:none; }
    .toast.show{opacity:1; transform: translateY(0)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>모니터 UI <span class="subtitle">/ Monitor · CH1–CH4</span></h1>
      <div>
        <button class="btn ghost" id="btnReboot" title="재시작">Reboot</button>
        <button class="btn ghost" id="btnLogout" title="로그아웃">Logout</button>
      </div>
    </div>
    
    <div class="panel">
      <div class="all-actions">
        <span class="tag">통합 녹화 · Unified Record</span>
        <button class="btn primary" id="btnAllStart">Start All</button>
        <button class="btn danger"  id="btnAllStop">Stop All</button>
        <span class="note">모든 채널에 일괄 적용됩니다 / Applies to all channels.</span>
      </div>

      <div class="table-wrap">
        <table>
          <!-- <thead>
            <tr>
              <th>동작 / Action</th>
              <th>CH1</th><th>CH2</th><th>CH3</th><th>CH4</th><th>CH5</th><th>CH6</th>
            </tr>
          </thead> -->
          <thead>
            <tr>
              <th>동작 / Action</th>
              <th><span class="ch-name" data-ch="1" tabindex="0">CH1</span></th>
              <th><span class="ch-name" data-ch="2" tabindex="0">CH2</span></th>
              <th><span class="ch-name" data-ch="3" tabindex="0">CH3</span></th>
              <th><span class="ch-name" data-ch="4" tabindex="0">CH4</span></th>
              <!-- <th><span class="ch-name" data-ch="5" tabindex="0">CH5</span></th>
              <th><span class="ch-name" data-ch="6" tabindex="0">CH6</span></th> -->
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>Record (녹화)</th>
              <td><button class="btn primary" data-action="record" data-ch="1">Record</button></td>
              <td><button class="btn primary" data-action="record" data-ch="2">Record</button></td>
              <td><button class="btn primary" data-action="record" data-ch="3">Record</button></td>
              <td><button class="btn primary" data-action="record" data-ch="4">Record</button></td>
              <!-- <td><button class="btn primary" data-action="record" data-ch="5">Record</button></td>
              <td><button class="btn primary" data-action="record" data-ch="6">Record</button></td> -->
            </tr>
            <tr>
              <th>Stop (정지)</th>
              <td><button class="btn danger" data-action="stop" data-ch="1">Stop</button></td>
              <td><button class="btn danger" data-action="stop" data-ch="2">Stop</button></td>
              <td><button class="btn danger" data-action="stop" data-ch="3">Stop</button></td>
              <td><button class="btn danger" data-action="stop" data-ch="4">Stop</button></td>
              <!-- <td><button class="btn danger" data-action="stop" data-ch="5">Stop</button></td>
              <td><button class="btn danger" data-action="stop" data-ch="6">Stop</button></td> -->
            </tr>
            <tr>
              <th>Capture / Snapshot (캡처)</th>
              <td><button class="btn ghost" data-action="capture" data-ch="1">Capture</button></td>
              <td><button class="btn ghost" data-action="capture" data-ch="2">Capture</button></td>
              <td><button class="btn ghost" data-action="capture" data-ch="3">Capture</button></td>
              <td><button class="btn ghost" data-action="capture" data-ch="4">Capture</button></td>
              <!-- <td><button class="btn ghost" data-action="capture" data-ch="5">Capture</button></td>
              <td><button class="btn ghost" data-action="capture" data-ch="6">Capture</button></td> -->
            </tr>
            <tr>
              <th>상태 / Status</th>
              <td><span class="status idle" id="st-1"><span class="dot"></span><span class="txt">Idle</span></span></td>
              <td><span class="status idle" id="st-2"><span class="dot"></span><span class="txt">Idle</span></span></td>
              <td><span class="status idle" id="st-3"><span class="dot"></span><span class="txt">Idle</span></span></td>
              <td><span class="status idle" id="st-4"><span class="dot"></span><span class="txt">Idle</span></span></td>
              <!-- <td><span class="status idle" id="st-5"><span class="dot"></span><span class="txt">Idle</span></span></td>
              <td><span class="status idle" id="st-6"><span class="dot"></span><span class="txt">Idle</span></span></td> -->
            </tr>
          </tbody>
        </table>
      </div>

      <!-- 这里保留了你原来的配置区注释块，如需启用可恢复 -->
    </div>
  </div>

  <div class="toast" id="toast">Done</div>

  <script>
    // ======= CONFIG =======
    const API_BASE = '';

    const ENDPOINTS = {
      record:'/record', stop:'/stop', capture:'/capture',
      getCfg:'/config', setCfg:'/config',
      me:'/auth/me',
      reboot:'/reboot',
      chNames:'/channel_names'   // ← 新增：通道名持久化接口
    };

    // ======= Auth Gate helpers =======
    function currentPathWithQuery(){
      const {pathname, search, hash} = location;
      return pathname + (search||'') + (hash||'');
    }
    function redirectToLogin(){
      const target = encodeURIComponent(currentPathWithQuery());
      location.replace(`/login.html?redirect=${target}`);
    }

    // 进入页面先检查本地是否有 token；再调用 /auth/me 校验
    (async function authGate(){
      const token = localStorage.getItem('mc_token');
      if(!token){ redirectToLogin(); return; }
      try{
        const res = await fetch(API_BASE+ENDPOINTS.me, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if(!res.ok){
          localStorage.removeItem('mc_token');
          redirectToLogin();
        }
      }catch(e){
        // 网络错误时可选择允许进入或提示，这里保持静默，交由后续请求再判 401
      }
    })();

    // ======= Helpers =======
    const qs  = (sel, el=document)=> el.querySelector(sel);
    const qsa = (sel, el=document)=> [...el.querySelectorAll(sel)];
    const statusEl = ch => qs(`#st-${ch}`);

    const channels = [1,2,3,4,5,6];
    const ChannelState = {}; for (const ch of channels) ChannelState[ch] = { main: 'idle', capturing: false };

    function renderOne(ch){
      const el = statusEl(ch); if(!el) return;
      el.classList.remove('idle','rec','capturing');
      if (ChannelState[ch].main === 'recording') el.classList.add('rec'); else el.classList.add('idle');
      if (ChannelState[ch].capturing) el.classList.add('capturing');
      const txt = el.querySelector('.txt');
      if (ChannelState[ch].main === 'recording') txt.textContent = ChannelState[ch].capturing ? 'Capturing' : 'Recording';
      else txt.textContent = ChannelState[ch].capturing ? 'Capturing' : 'Idle';
    }
    function renderAll(){ for (const ch of channels) renderOne(ch); }
    function setMain(ch, next){ ChannelState[ch].main = next; renderOne(ch); }
    function setCapturing(ch, flag){ ChannelState[ch].capturing = !!flag; renderOne(ch); }

    const toast = (msg='OK')=>{ const t=qs('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1200); };

    // 统一的 API 调用：自动附加 Authorization，401 统一处理
    async function callAPI(path, method='GET', body){
      const url = API_BASE + path;
      const headers = {};
      const token = localStorage.getItem('mc_token');
      if(token) headers['Authorization'] = 'Bearer ' + token;
      const opt = { method, headers };
      if (body !== undefined) {
        headers['Content-Type'] = 'application/json';
        opt.body = JSON.stringify(body);
      }

      const res = await fetch(url, opt);

      // 未授权统一处理
      if(res.status === 401){
        localStorage.removeItem('mc_token');
        toast('세션이 만료되었습니다 / Login expired');
        redirectToLogin();
        throw new Error('Unauthorized');
      }

      // 截图流：按你原有逻辑处理
      const ct = res.headers.get('Content-Type') || '';
      if (path === ENDPOINTS.capture && ct.startsWith('image/')) {
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const ch = (body && (body.channel || body.cid)) ?? 'ch';
        a.download = `capture_${ch}.jpg`;
        document.body.appendChild(a); a.click(); a.remove();
        return { ok: true, downloaded: true };
      }

      const data = await res.json().catch(()=> ({}));
      if(!res.ok || data.ok === false){ throw new Error((data && data.error) || `HTTP ${res.status}`); }
      return data;
    }

    // ======= Button actions =======
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;

      // Logout
      if(btn.id === 'btnLogout'){
        localStorage.removeItem('mc_token');
        redirectToLogin();
        return;
      }

      // Reboot（通过后端代理）
      if (btn.id === 'btnReboot') {
        if (!confirm('정말로 재시작할까요?')) return;
        await callAPI(ENDPOINTS.reboot, 'POST');  // ← 必须是 POST
        toast('장치 재시작 중… 60–90초 후 새로고침');
        localStorage.removeItem('mc_token');
        redirectToLogin();
        return;
      }
      // Per-channel controls
      if(btn.dataset.action){
        const action = btn.dataset.action;
        const ch = parseInt(btn.dataset.ch, 10);
        try{
          if(action==='record'){
            setMain(ch, 'recording');
            await callAPI(ENDPOINTS.record, 'POST', {channel: ch});
            setMain(ch, 'recording'); toast(`CH${ch} Recording`);
          }else if(action==='stop'){
            await callAPI(ENDPOINTS.stop, 'POST', {channel: ch});
            setMain(ch, 'idle'); toast(`CH${ch} Stopped`);
          }else if(action==='capture'){
            if (ChannelState[ch].capturing) return;
            setCapturing(ch, true);
            try{
              const res = await callAPI(ENDPOINTS.capture, 'POST', { cid: ch, format: 'jpg', resolution: 'auto', keep_aspect_ratio: true });
              if (res && res.url) console.log('Capture saved at:', res.url);
              toast(`CH${ch} Captured`);
            } finally {
              setCapturing(ch, false);
            }
          }
        }catch(err){ console.error(err); toast('Action failed'); }
        return;
      }

      // All start/stop
      if(btn.id==='btnAllStart'){
        for(const ch of channels) setMain(ch,'recording');
        try{ await callAPI(ENDPOINTS.record, 'POST', {channel:'all'}); toast('All Recording'); }
        catch(err){ console.error(err); toast('All start failed'); }
        return;
      }
      if(btn.id==='btnAllStop'){
        try{ await callAPI(ENDPOINTS.stop, 'POST', {channel:'all'}); for(const ch of channels) setMain(ch,'idle'); toast('All Stopped'); }
        catch(err){ console.error(err); toast('All stop failed'); }
        return;
      }
    });


        // // —— 可编辑通道名 —— //
        // const NAME_KEY = 'mc_ch_names';
        // const defaultNames = Object.fromEntries([1,2,3,4,5,6].map(n=>[n, `CH${n}`]));
        // const chNames = (()=> {
        //   try { return {...defaultNames, ...JSON.parse(localStorage.getItem(NAME_KEY)||'{}')} }
        //   catch { return {...defaultNames} }
        // })();

        // const getName = ch => chNames[ch] || `CH${ch}`;
        // const saveNames = () => localStorage.setItem(NAME_KEY, JSON.stringify(chNames));

        // function renderHeaderNames(){
        //   document.querySelectorAll('.ch-name').forEach(el=>{
        //     const ch = Number(el.dataset.ch);
        //     el.textContent = getName(ch);
        //   });
        // }

        // // 双击进入编辑；回车保存；Esc 取消；失焦也保存
        // document.addEventListener('dblclick', e=>{
        //   const el = e.target.closest('.ch-name');
        //   if(!el) return;
        //   el.setAttribute('contenteditable','true');
        //   const range = document.createRange();
        //   range.selectNodeContents(el);
        //   const sel = window.getSelection();
        //   sel.removeAllRanges(); sel.addRange(range);
        //   el.focus();
        // });

        // document.addEventListener('keydown', e=>{
        //   const el = e.target.closest('.ch-name');
        //   if(!el) return;
        //   if(e.key === 'Enter'){
        //     e.preventDefault();
        //     el.blur();
        //   }else if(e.key === 'Escape'){
        //     const ch = Number(el.dataset.ch);
        //     el.textContent = getName(ch);
        //     el.blur();
        //   }
        // });

        // document.addEventListener('blur', e=>{
        //   const el = e.target.closest('.ch-name');
        //   if(!el) return;
        //   el.removeAttribute('contenteditable');
        //   const ch = Number(el.dataset.ch);
        //   const val = el.textContent.trim();
        //   chNames[ch] = val || `CH${ch}`;
        //   saveNames();
        //   renderHeaderNames();
        // }, true);

        // // 初次渲染
        // renderHeaderNames();

        
// —— 可编辑通道名（改为后端持久化） —— //
let chNames = {}; // { "1":"Lecture", "2":"Room B", ... }
const defaultNames = Object.fromEntries([1,2,3,4,5,6].map(n=>[String(n), `CH${n}`]));

// 从后端加载
async function loadNames(){
  try{
    const res = await callAPI(ENDPOINTS.chNames, 'GET');
    const server = (res && res.names) || {};
    chNames = { ...defaultNames, ...server };
  }catch(e){
    console.error('Load channel names failed:', e);
    chNames = {...defaultNames}; // 失败就用默认
  }finally{
    renderHeaderNames();
  }
}

// 写回后端
let _saveTimer = null;
function saveNamesDebounced(){
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(()=>{
    callAPI(ENDPOINTS.chNames, 'PUT', { names: chNames })
      .catch(err=>console.error('Save channel names failed:', err));
  }, 150);
}

const getName = ch => chNames[String(ch)] || `CH${ch}`;

function renderHeaderNames(){
  document.querySelectorAll('.ch-name').forEach(el=>{
    const ch = Number(el.dataset.ch);
    el.textContent = getName(ch);
  });
}

// 双击进入编辑；回车保存；Esc 取消；失焦保存
document.addEventListener('dblclick', e=>{
  const el = e.target.closest('.ch-name');
  if(!el) return;
  el.setAttribute('contenteditable','true');
  const range = document.createRange();
  range.selectNodeContents(el);
  const sel = window.getSelection();
  sel.removeAllRanges(); sel.addRange(range);
  el.focus();
});

document.addEventListener('keydown', e=>{
  const el = e.target.closest('.ch-name');
  if(!el) return;
  if(e.key === 'Enter'){
    e.preventDefault();
    el.blur();
  }else if(e.key === 'Escape'){
    const ch = Number(el.dataset.ch);
    el.textContent = getName(ch);
    el.blur();
  }
});

document.addEventListener('blur', e=>{
  const el = e.target.closest('.ch-name');
  if(!el) return;
  el.removeAttribute('contenteditable');
  const ch = el.dataset.ch;
  const val = (el.textContent || '').trim();
  chNames[String(ch)] = val || `CH${ch}`;
  renderHeaderNames();
  saveNamesDebounced(); // ← 写回后端文件
}, true);

// 兜底：页面关闭/隐藏前再保存一次
window.addEventListener('beforeunload', ()=> saveNamesDebounced());
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState === 'hidden') saveNamesDebounced();
});

// —— 把 toast 文案里的 CHx 也替换成自定义名 —— //
const nm = ch => getName(ch);

// 初次从后端加载并渲染
loadNames();

  // ——（可选）把提示里的“CHx”也换成自定义名 —— //
  // const nm = ch => getName(ch);
  // 把下面这些 toast 文案里的 `CH${ch}` 改成 nm(ch)：
  //   toast(`CH${ch} Recording`)  ->  toast(`${nm(ch)} Recording`)
  //   toast(`CH${ch} Stopped`)    ->  toast(`${nm(ch)} Stopped`)
  //   toast(`CH${ch} Captured`)   ->  toast(`${nm(ch)} Captured`)


   
    // 兜底保存：页面隐藏 / 关闭前都再存一次
    window.addEventListener('beforeunload', () => {
      try { localStorage.setItem('mc_ch_names', JSON.stringify(chNames)); } catch {}
    });
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        try { localStorage.setItem('mc_ch_names', JSON.stringify(chNames)); } catch {}
      }
    });

     // 初始渲染
    renderAll();
</script>
</body>
</html>
