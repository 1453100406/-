<!-- =========================
= login.html
========================= -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>로그인 · Backend Config</title>
  <style>
    :root{--bg:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--acc:#3b82f6;--radius:14px}
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 700px at 70% -10%, #1f2937 0%, #0b1220 45%, #030712 100%);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'PingFang SC','Noto Sans CJK SC','Noto Sans KR','Microsoft Yahei',sans-serif}
    .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px}
    .card{width:min(560px,100%);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);padding:22px 20px;box-shadow:0 20px 40px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.04)}
    h1{margin:0 0 6px 0;font-size:22px;font-weight:800}
    .sub{color:var(--muted);margin-bottom:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:#cbd5e1}
    input{height:42px;padding:0 12px;border-radius:10px;border:1px solid rgba(148,163,184,.35);background:rgba(255,255,255,.04);color:var(--text)}
    .row{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:14px;flex-wrap:wrap}
    .btn{height:38px;padding:0 14px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#e5e7eb;cursor:pointer;transition:.18s;box-shadow:inset 0 1px 0 rgba(255,255,255,.06)}
    .btn:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.06)}
    .primary{background:linear-gradient(180deg,#2563eb,#1d4ed8);border-color:rgba(59,130,246,.6)}
    .note{font-size:12px;color:#9aa4b2;margin-top:8px}
    .toast{position:fixed;right:16px;bottom:16px;padding:10px 14px;border-radius:10px;background:#0b1220;border:1px solid rgba(148,163,184,.25);color:#e5e7eb;box-shadow:0 8px 18px rgba(0,0,0,.35);opacity:0;transform:translateY(6px);transition:.2s;pointer-events:none}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>뮤지엄아이 녹화기 제어 시스템</h1>
    <div class="sub">PEARL 접속 정보와 캡처 저장 경로를 설정하고 로그인하세요.</div>
    <div class="grid">
      <div class="field">
        <label for="host">녹화기_IP</label>
        <input id="host" placeholder="e.g. 192.168.5.120">
      </div>
      <div class="field">
        <label for="user">PEARL_USER</label>
        <input id="user" placeholder="e.g. admin" autocomplete="username">
      </div>
      <div class="field">
        <label for="pass">PEARL_PASS</label>
        <input id="pass" type="password" placeholder="••••••" autocomplete="current-password">
      </div>
      <div class="field" style="grid-column:1/-1">
        <label for="saveDir">CAPTURE_SAVE_DIR (Server absolute path)</label>
        <input id="saveDir" placeholder="e.g. C:\\Users\\lenovo\\Desktop\\TestSave">
        <div class="note">* 후단 서버에서의 절대 경로를 작성하세요. 비워 두면 후단 기본값이 적용됩니다.</div>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="btnTest">Test Connection</button>
      <button class="btn" id="btnCfgLoad">Save Path</button>
      <button class="btn primary" id="btnLogin">Login</button>
    </div>
    <div class="note">로그인 전에 먼저 Test를 클릭하여 연결을 검증해야 하며, Save Path를 클릭하여 Snapshot의 저장 경로를 설정해야 합니다.</div>
  </div>
</div>
<div class="toast" id="toast">OK</div>
<script>
  const API_BASE = '';
  const ENDPOINTS = { getCfg:'/config', setCfg:'/config', test:'/auth/test', login:'/auth/login', me:'/auth/me' };

  const qs = (s,el=document)=>el.querySelector(s);
  const toast = (m='OK')=>{const t=qs('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1200)}

  function getRedirectTarget(){
    const u = new URL(location.href);
    const r = u.searchParams.get('redirect');
    return r && r.startsWith('/') ? r : 'index.html'; // 改成你的首页文件名
  }

  async function callAPI(path, method='GET', body){
    const opt={method,headers:{}};
    if(body!==undefined){opt.headers['Content-Type']='application/json';opt.body=JSON.stringify(body)}
    const res=await fetch(API_BASE+path,opt);
    const data=await res.json().catch(()=>({}));
    if(!res.ok||data.ok===false) throw new Error(data.error||`HTTP ${res.status}`);
    return data;
  }

  // 若已登录，则自动校验并直达
  (async function autoPassIfLoggedIn(){
    const token = localStorage.getItem('mc_token');
    if(!token) return;
    try{
      const res = await fetch(API_BASE+ENDPOINTS.me, { headers: { 'Authorization': 'Bearer ' + token }});
      if(res.ok){ location.replace(getRedirectTarget()); }
      else{ localStorage.removeItem('mc_token'); }
    }catch(e){ /* 网络失败时不跳转 */ }
  })();

  // Load existing config（你按钮文案叫“Save Path”，但这里是读取后端当前配置）
  qs('#btnCfgLoad').addEventListener('click', async()=>{
    try{
      const cfg = await callAPI(ENDPOINTS.getCfg,'GET');
      qs('#host').value=cfg.host??'';
      qs('#user').value=cfg.user??'';
      qs('#pass').value=cfg.pass??'';
      qs('#saveDir').value=cfg.capture_dir??'';
      toast('Loaded');
    }catch(e){ console.error(e); toast('Load failed'); }
  });

  // Test connection (does not persist)
  qs('#btnTest').addEventListener('click', async()=>{
    const host=qs('#host').value.trim(), user=qs('#user').value.trim(), pass=qs('#pass').value;
    if(!host){alert('PEARL_HOST 를 입력하세요.');return}
    try{ const r = await callAPI(ENDPOINTS.test,'POST',{host,user,pass}); toast(r.message||'Test OK'); }
    catch(e){ console.error(e); toast('Test failed'); }
  });

  // Save & Login（关键更改：capture_dir 为空时不发送该字段）
  qs('#btnLogin').addEventListener('click', async()=>{
    const host=qs('#host').value.trim(), user=qs('#user').value.trim(), pass=qs('#pass').value;
    const capture_dir_raw = qs('#saveDir').value;
    const capture_dir = capture_dir_raw ? capture_dir_raw.trim() : '';

    if(!host){alert('PEARL_HOST 를 입력하세요.');return}
    try{
      const body = { host, user, pass };
      if (capture_dir) body.capture_dir = capture_dir; // 只有非空才发送

      await callAPI(ENDPOINTS.setCfg,'PUT', body);

      // 执行登录：后端读取已保存的 cfg 进行校验
      const r = await callAPI(ENDPOINTS.login,'POST',{});
      if(r && r.token){
        localStorage.setItem('mc_token', r.token);
        location.href = getRedirectTarget();
      }else{
        localStorage.removeItem('mc_token');
        toast('Login failed');
      }
    }catch(e){
      console.error(e);
      localStorage.removeItem('mc_token');
      toast('Save/Login failed');
    }
  });
</script>
</body>
</html>
